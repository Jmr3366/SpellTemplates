function Board(a,b){this.hex_mode=!1,this.tile_count=0,this.tile_set=[],this.tile_size_multiplier=1,this.origin={x:null,y:null},this.tile_width=30,this.tile_height=30,this.height,this.width,this.drawBoard=function(c,d,e,f){var g=e;this.origin={x:c,y:d};var h=c,i=d;for(this.tile_count=0;d+f-i>=this.tile_height+1;){for(var j=[];c+e-h>=this.tile_width+1;){var k=new Tile(h,i,this.tile_height,this.tile_width,a,b);k.drawTile(),j.push(k),h+=this.tile_width,this.tile_count++}g=e,h=c,this.tile_set.push(j),i+=this.tile_height}this.width=this.tile_set[0].length*this.tile_width,this.height=this.tile_set.length*this.tile_height},this.getTileByCoord=function(a,b){return(a-=this.origin.x,b-=this.origin.y,0>b)?null:0>a?null:(a=(a-a%this.tile_width)/this.tile_width,b=(b-b%this.tile_height)/this.tile_height,b>=this.tile_set.length?null:a>=this.tile_set[0].length?null:this.tile_set[b][a])},this.getRowByCoord=function(a){return(a-=this.origin.y,0>a)?null:(a=(a-a%this.tile_height)/this.tile_height,a>=this.tile_set.length?null:a)},this.getColByCoord=function(a){return(a-=this.origin.x,0>a)?null:(a=(a-a%this.tile_width)/this.tile_width,a>=this.tile_set[0].length?null:a)},this.showCoverageCone=function(a){for(i=0;i<this.tile_set.length;i++)for(var b=0;b<this.tile_set[i].length;b++)this.tile_set[i][b].calculateHitCone(a)},this.clearTiles=function(){for(i=0;i<this.tile_set.length;i++)for(var a=0;a<this.tile_set[i].length;a++)this.tile_set[i][a].clearTile()},this.resetHits=function(){for(i=0;i<this.tile_set.length;i++)for(var a=0;a<this.tile_set[i].length;a++)this.tile_set[i][a].isHit=!1,this.tile_set[i][a].entity&&(this.tile_set[i][a].entity.clear(),this.tile_set[i][a].entity.draw())},this.colourHits=function(a){for(i=0;i<this.tile_set.length;i++)for(var b=0;b<this.tile_set[i].length;b++)this.tile_set[i][b].isHit&&(this.tile_set[i][b].fillTile(a),this.tile_set[i][b].entity&&(this.tile_set[i][b].entity.clear(),this.tile_set[i][b].entity.draw()))},this.refresh=function(){for(i=0;i<this.tile_set.length;i++)for(var a=0;a<this.tile_set[i].length;a++)this.tile_set[i][a].drawTile()},this.unitList=function(){var a=[];for(i=0;i<this.tile_set.length;i++)for(var b=0;b<this.tile_set[i].length;b++)this.tile_set[i][b].entity&&a.push({unit:this.tile_set[i][b].entity,x:b,y:i});return a},this.clearUnits=function(){for(i=0;i<this.tile_set.length;i++)for(var a=0;a<this.tile_set[i].length;a++)this.tile_set[i][a].entity&&(this.tile_set[i][a].entity=null)}}var bw,bh,longPressTimer,longPressOrigin,board,template,mousedown=!1,ongoingTouches=0,LONG_PRESS_FORGIVENESS=5,LONG_PRESS_VIBRATION=[75],unitPlacementMode=!1,unitStyle=0,unitSvgDelay=500,settings={},canvasDiv=document.getElementById("canvasDiv"),canvasGrid=document.getElementById("canvasGrid"),contextGrid=canvasGrid.getContext("2d"),canvasUnits=document.getElementById("canvasUnits"),contextUnits=canvasUnits.getContext("2d"),canvasTemplate=document.getElementById("canvasTemplate"),contextTemplate=canvasTemplate.getContext("2d"),canvasTiles=document.getElementById("canvasTiles"),contextTiles=canvasTiles.getContext("2d"),templateSize=parseInt(getParameterByName("size"))||3;function getMousePos(a,b){var c=a.getBoundingClientRect();return b.touches&&(b=b.touches[0]),{x:b.clientX-c.left,y:b.clientY-c.top}}function resizeCanvas(a,b,c){a.width=b,a.height=c}function vibrate(a){navigator.vibrate=navigator.vibrate||navigator.webkitVibrate||navigator.mozVibrate||navigator.msVibrate,navigator.vibrate&&navigator.vibrate(...a)}function clearAll(){template.clear(),board.clearTiles(),board.resetHits()}function paintTemplate(){clearAll(),template.originLocked&&template.drawOrigin(),template.draw(),template.calculateHit(board),board.colourHits("#E55934")}function placeUnit(a){var b=board.getTileByCoord(a.x,a.y);b&&(b.entity?(b.entity.clear(),b.entity=null):(b.entity=new Unit(b,unitStyle,contextUnits),b.entity.draw()))}function mousedown_func(a){a.preventDefault(),mousedown=!0;var b=getMousePos(canvasGrid,a);return unitPlacementMode?void placeUnit(b):void(template.snapping=settings.template_snapping,template.setOrigin(b,board.getTileByCoord(b.x,b.y)),template.originLocked||!template.terminusRequired?mousemove_func(a):clearAll())}function mousemove_func(a){if(a.preventDefault(),mousedown){if(unitPlacementMode)return;var b=getMousePos(canvasGrid,a);template.setVector(b,board.tile_width*templateSize),paintTemplate()}}function mouseup_func(a){a.preventDefault(),mousedown=!1}function dblclick_func(a){if(a.preventDefault(),!unitPlacementMode){getMousePos(canvasGrid,a);template.originLocked?(template.unlockOrigin(),board.clearTiles(),mousedown_func(a),mousedown=!1):(template.lockOrigin(),template.drawOrigin(),!template.terminusRequired&&mousemove_func(a))}}function touchstart_func(a){ongoingTouches+=a.changedTouches.length,1==ongoingTouches?(longPressOrigin={x:a.touches[0].clientX,y:a.touches[0].clientY},longPressTimer=setTimeout(function(){vibrate(LONG_PRESS_VIBRATION),dblclick_func(a)},500),mousedown_func(a)):clearTimeout(longPressTimer)}function touchmove_func(a){if(1==ongoingTouches){if(longPressOrigin){var b=a.touches[0].clientX-longPressOrigin.x,c=a.touches[0].clientY-longPressOrigin.y;Math.sqrt(b*b+c*c)>LONG_PRESS_FORGIVENESS&&(clearTimeout(longPressTimer),longPressOrigin=null)}mousemove_func(a)}}function touchend_func(a){ongoingTouches-=a.changedTouches.length,1>=ongoingTouches&&(clearTimeout(longPressTimer),longPressOrigin=null,mouseup_func(a))}function resize_func(){clearTimeout(void 0);setTimeout(function(){init_canvases()},200)}function keydown_func(a){var b=secretCode(a.keyCode);b&&(console.log("Sequence Complete!"),midi=new Audio("secret.mp3"),midi.volume=.3,midi.loop=!0,midi.play())}function init_canvases(){bw=parseInt(getComputedStyle(canvasDiv,null).getPropertyValue("width").replace("px","")),bh=parseInt(getComputedStyle(canvasDiv,null).getPropertyValue("height").replace("px","")),resizeCanvas(canvasGrid,bw,bh),resizeCanvas(canvasUnits,bw,bh),resizeCanvas(canvasTemplate,bw,bh),resizeCanvas(canvasTiles,bw,bh);var a=[];switch(board&&(a=board.unitList()),board=new Board(contextGrid,contextTiles),board.drawBoard(Math.floor((bw-1)%board.tile_width/2),0,bw,bh),init_units(a),template?template.constructor.name:""){case"LineTemplate":set_template_line();break;case"ConeTemplate":set_template_cone();break;case"CircleTemplate":set_template_circle();break;default:set_template_circle();}}function init_units(a){for(var b,c=0;c<a.length;c++)if(b=board.tile_set[a[c].y],!!b){var d=b[a[c].x];d&&(d.entity=a[c].unit,d.entity.setTile(d),d.entity.draw())}}function first_load(){document.cookie.includes("settings")&&(read_settings_cookie(),write_settings_cookie()),init_canvases();var a=getParameterByName("shape");"line"===a?set_template_line():"cone"===a?set_template_cone():"circle"===a?set_template_circle():set_template_circle();templateSize--,increment_template_size();var b=getParameterByName("units");if(b&&2<=b.split("x").length){unitListString=b.split(","),unitList=[];for(var a,c=0;c<unitListString.length;c++)a=unitListString[c].split("x")[2]||0,unitList.push({unit:new Unit(null,a,contextUnits),x:unitListString[c].split("x")[0],y:unitListString[c].split("x")[1]});console.log("Units from param: ",JSON.stringify(b.split(","))),init_units(unitList)}var d=getParameterByName("templateSize");0==d%5&&1<=d/5&&25>=d/5&&set_template_size(d/5);var e=getParameterByName("origin"),f=getParameterByName("terminus");e&&2==e.split("x").length&&(e={x:parseFloat(e.split("x")[0])+board.origin.x,y:parseFloat(e.split("x")[1])+board.origin.y},console.log("Origin from param: ",e),template.setOrigin(e),template.originLocked=!0,f&&2==f.split("x").length&&(f={x:parseFloat(f.split("x")[0])+board.origin.x,y:parseFloat(f.split("x")[1])+board.origin.y},console.log("Terminus from param: ",f),template.setTerminus(f),template.setVector(template.terminus,board.tile_width*templateSize),paintTemplate()))}function set_template_size(a){templateSize=a,document.getElementById("templateSizeLabel").innerHTML=""+5*templateSize+"ft",template.changeMagnitude(board.tile_width*templateSize),template.isDrawn&&paintTemplate()}function increment_template_size(){25>templateSize&&set_template_size(templateSize+1)}function decrement_template_size(){1<templateSize&&set_template_size(templateSize-1)}function set_template_cone(){if(unitPlacementMode=!1,set_menu_highlight("coneTemplateButton"),null==template)return void(template=new ConeTemplate(contextTemplate,canvasTemplate.width,canvasTemplate.height,board));var a=template.origin,b=template.originLocked,c=template.terminus,d=template.isDrawn;template=new ConeTemplate(contextTemplate,canvasTemplate.width,canvasTemplate.height,board),template.setOrigin(a),template.setVector(c,board.tile_width*templateSize),template.originLocked=b,template.isDrawn=d,settings.hit_threshold&&(template.minHitFactor=settings.hit_threshold/100),template.isDrawn&&paintTemplate()}function set_template_line(){if(unitPlacementMode=!1,set_menu_highlight("lineTemplateButton"),null==template)return void(template=new LineTemplate(contextTemplate,canvasTemplate.width,canvasTemplate.height,board));var a=template.origin,b=template.originLocked,c=template.terminus,d=template.isDrawn;template=new LineTemplate(contextTemplate,canvasTemplate.width,canvasTemplate.height,board),template.setOrigin(a),template.setVector(c,board.tile_width*templateSize),template.originLocked=b,template.isDrawn=d,settings.hit_threshold&&(template.minHitFactor=settings.hit_threshold/100),template.isDrawn&&paintTemplate()}function set_template_circle(){if(unitPlacementMode=!1,set_menu_highlight("circleTemplateButton"),null==template)return void(template=new CircleTemplate(contextTemplate,canvasTemplate.width,canvasTemplate.height,board));var a=template.origin,b=template.originLocked,c=template.terminus,d=template.isDrawn;template=new CircleTemplate(contextTemplate,canvasTemplate.width,canvasTemplate.height,board),template.setOrigin(a),template.setTerminus(c),template.setVector(c,board.tile_width*templateSize),template.setOrigin(a),template.originLocked=b,template.isDrawn=d,settings.hit_threshold&&(template.minHitFactor=settings.hit_threshold/100),template.isDrawn&&paintTemplate()}function toggle_place_units(){unitPlacementMode?0==unitStyle?unitStyle=4:4==unitStyle?unitStyle=6:unitStyle=0:(unitPlacementMode=!0,unitStyle=0),set_menu_highlight("placeUnitsButton"),flash_unit_shape()}function flash_unit_shape(){var a=4===unitStyle?document.querySelector("#unitsShape4"):6===unitStyle?document.querySelector("#unitsShape6"):document.querySelector("#unitsShape0");a.style="opacity:0.25;",shapeDisplayTimeout=setTimeout(function(a){a.style="opacity:0;"},unitSvgDelay,a)}function set_menu_highlight(a){for(var b=document.querySelectorAll("#toolbarBtnDiv .highlight"),c=b.length-1;0<=c;c--)b[c].classList.remove("highlight");document.getElementById(a).classList.add("highlight")}function open_settings_menu(){document.getElementById("settingsDiv").classList.add("active")}function close_settings_menu(){write_settings_cookie(),document.getElementById("settingsDiv").classList.remove("active")}function update_settings(){var a={};a.tile_size=document.querySelector(".tile-size.slider").value,a.hit_threshold=document.querySelector(".hit-threshold.slider").value,a.template_snapping=document.querySelector(".template-snapping.input").checked,settings=a,init_canvases()}function update_settings_menu(){document.querySelector(".tile-size.slider").value=settings.tile_size,document.querySelector(".hit-threshold.slider").value=settings.hit_threshold,document.querySelector(".template-snapping.input").checked=settings.template_snapping,slider_update({target:document.querySelector(".tile-size.slider")}),slider_update({target:document.querySelector(".hit-threshold.slider")})}function reset_settings(){settings={tile_size:"30",hit_threshold:"50",template_snapping:!1},update_settings_menu(),init_canvases()}function write_settings_cookie(){var a=new Date(Date.now()+5184000000),b=["settings=",JSON.stringify(settings),";","expires=",a.toUTCString(),";"].join("");document.cookie=b}function read_settings_cookie(){var a=document.cookie.match(/settings=([^;]+)/);a&&(a=JSON.parse(a[1])),settings=a,update_settings_menu()}function slider_update(a){var b=a.target.classList.value.replace("slider","").replace("input","").replace("setting","").trim(),c=document.querySelector(".output."+b);c.innerHTML=a.target.value}function export_state(){var a=(""+window.location).split("?")[0],b=[];template.isDrawn&&(b.push("templateSize="+5*templateSize),b.push("shape="+template.shape),b.push("origin="+(template.origin.x-board.origin.x)+"x"+(template.origin.y-board.origin.y)),b.push("terminus="+(template.terminus.x-board.origin.x)+"x"+(template.terminus.y-board.origin.y)));for(var c=board.unitList(),d="",e=0;e<c.length;e++)0!=e&&(d+=","),d+=c[e].x+"x"+c[e].y+"x"+c[e].unit.shape;""!=d&&b.push("units="+d),0<b.length&&(a=a+"?"+b.join("&")),document.querySelector("#export_tb").disabled=!1,document.querySelector("#export_tb").value=a}function clear_state(){board.clearUnits(),template.clear(),init_canvases()}function copy_value(a){a.select(),a.disabled=!0;var b=a.value;document.execCommand("copy"),a.value="Copied to clipboard!",setTimeout(function(a,b){a.value=b,a.disabled=!1},850,a,b)}function getParameterByName(a,b){b||(b=window.location.href),a=a.replace(/[\[\]]/g,"\\$&");var c=new RegExp("[?&]"+a+"(=([^&#]*)|&|#|$)"),d=c.exec(b);return d?d[2]?decodeURIComponent(d[2].replace(/\+/g," ")):"":null}var currentLoc=0;function secretCode(a){var b={37:"left",38:"up",39:"right",40:"down",65:"a",66:"b"},c=["up","up","down","down","left","right","left","right","b","a"];return c[currentLoc]==b[a]?currentLoc++:c[0]==b[a]?currentLoc=1:currentLoc=0,currentLoc==c.length&&(currentLoc=0,!0)}first_load(),canvasTemplate.addEventListener("mousedown",mousedown_func,{passive:!1}),canvasTemplate.addEventListener("touchstart",touchstart_func,{passive:!1}),canvasTemplate.addEventListener("mousemove",mousemove_func,{passive:!1}),canvasTemplate.addEventListener("touchmove",touchmove_func,{passive:!1}),canvasTemplate.addEventListener("mouseup",mouseup_func,{passive:!1}),canvasTemplate.addEventListener("touchend",touchend_func,{passive:!1}),canvasTemplate.addEventListener("touchcancel",touchend_func,{passive:!1}),canvasTemplate.addEventListener("dblclick",dblclick_func,{passive:!1}),window.addEventListener("keydown",keydown_func,{passive:!1}),document.defaultView.addEventListener("resize",resize_func,{passive:!0}),document.getElementById("incrementTemplateSize").addEventListener("click",increment_template_size,{passive:!0}),document.getElementById("decrementTemplateSize").addEventListener("click",decrement_template_size,{passive:!0}),document.getElementById("coneTemplateButton").addEventListener("click",set_template_cone,{passive:!0}),document.getElementById("lineTemplateButton").addEventListener("click",set_template_line,{passive:!0}),document.getElementById("circleTemplateButton").addEventListener("click",set_template_circle,{passive:!0}),document.getElementById("placeUnitsButton").addEventListener("click",toggle_place_units,{passive:!0}),document.getElementById("settingsButton").addEventListener("click",open_settings_menu,{passive:!0}),document.getElementById("settingsCloseButton").addEventListener("click",close_settings_menu,{passive:!0});for(var sliders=document.getElementsByClassName("slider"),i=0;i<sliders.length;i++)sliders[i].addEventListener("input",slider_update,{passive:!0});for(var settings_inputs=document.getElementsByClassName("setting"),i=0;i<settings_inputs.length;i++)settings_inputs[i].addEventListener("input",update_settings,{passive:!0});function Template(a,b,c,d){var e=Math.sign,f=Math.round,g=Math.min,h=Math.ceil,i=Math.max,j=Math.floor,k=Math.sqrt;this.size_multiplier=1,this.origin={x:null,y:null},this.originTile=null,this.terminus={x:null,y:null},this.originLocked=!1,this.minHitFactor=.5,this.isDrawn=!1,this.terminusRequired=!0,this.shape="template",this.lineColour="#9E3316",this.snapping=!1,this.drawBox=function(b,c){a.beginPath(),a.rect(b.x,b.y,150,200),this.origin={x:b.x,y:b.y},this.originTile=c,a.fillStyle="red",a.fill()},this.drawLine=function(){a.beginPath(),a.moveTo(this.origin.x,this.origin.y),a.lineTo(this.terminus.x,this.terminus.y),a.lineWidth=2,a.strokeStyle=this.lineColour,a.stroke()},this.drawPoint=function(b,c=this.lineColour,d=5){a.beginPath(),a.arc(b.x,b.y,d,0,2*Math.PI),a.lineWidth=2,a.strokeStyle=c,a.stroke()},this.fillPoly=function(b,c){a.beginPath(),a.moveTo(b[0].x,b[0].y);for(var d=0;d<b.length-1;d++)a.lineTo(b[d+1].x,b[d+1].y);a.lineTo(b[0].x,b[0].y),a.fillStyle=c,a.fill()},this.calculateHitPoly=function(a){var b=j((this.farthestBound(a,"min","x")-d.origin.x)/d.tile_width+1)*d.tile_width+d.origin.x;b=i(b,d.origin.x);var c=h((this.farthestBound(a,"max","x")-d.origin.x)/d.tile_width)*d.tile_width+d.origin.x;for(c=g(c,d.origin.x+d.width);b<=c;){if(b==c){this.calculateHitColumn(a,b);break}var e=this.slicePoly(a,b,!0);a=e[1];var f=e[0];if(this.roundPoly(a),this.roundPoly(f),!a){b+=d.tile_width,a=e[0];continue}if(this.calculateHitColumn(f,b),b+=d.tile_width,1==e.length)break}},this.calculateHitColumn=function(a,b){var c=j((this.farthestBound(a,"min","y")+1-d.origin.y)/d.tile_height+1)*d.tile_height+d.origin.y;c=i(c,d.origin.y);var e=h((this.farthestBound(a,"max","y")-d.origin.y)/d.tile_height)*d.tile_height+d.origin.y;for(e=g(e,d.origin.y+d.height);c<=e;){if(c==e){this.calculateHitTile(a,b,c);break}var f=this.slicePoly(a,c,!1);a=f[1];var k=f[0];if(this.roundPoly(a),this.roundPoly(k),!a){c+=d.tile_height,a=f[0];continue}if(this.calculateHitTile(k,b,c),c+=d.tile_height,1==f.length)break}},this.calculateHitTile=function(a,b,c){!a||f(this.polyArea(a))>=d.tile_width*d.tile_height*this.minHitFactor&&(d.getTileByCoord(b-d.tile_width/2,c-d.tile_height/2).isHit=!0)},this.setOrigin=function(a,b){this.originLocked||(this.snapping&&(a.x=f((a.x-d.origin.x)/(d.tile_width/2))*(d.tile_width/2)+d.origin.x,a.y=f((a.y-d.origin.y)/(d.tile_width/2))*(d.tile_width/2)+d.origin.y),this.origin={x:a.x,y:a.y},this.originTile=b)},this.drawOrigin=function(){this.drawPoint(this.origin,this.lineColour,10)},this.setTerminus=function(a){this.terminus={x:a.x,y:a.y}},this.drawTerminus=function(){this.drawPoint(this.terminus,this.lineColour,10)},this.setVector=function(a,b){var c=a.x-this.origin.x,d=a.y-this.origin.y,f=d/c;if(0==d&&(f=0),0==c)return void(this.terminus={x:this.origin.x,y:this.origin.y+b*e(d)});var g=k(1+f*f),h=b/g;this.terminus={x:this.origin.x+h*e(c),y:this.origin.y+h*f*e(c)}},this.changeMagnitude=function(a){this.setVector(this.terminus,a)},this.lockOrigin=function(){this.originLocked=!0},this.unlockOrigin=function(){this.originLocked=!1},this.cropPoly=function(a,b,c){return this.farthestBound(a,"min","x")<b.x&&(a=this.slicePoly(a,b.x,!0)[1],this.roundPoly(a)),this.farthestBound(a,"max","x")>c.x&&(a=this.slicePoly(a,c.x,!0)[0],this.roundPoly(a)),this.farthestBound(a,"min","y")<b.y&&(a=this.slicePoly(a,b.y,!1)[1],this.roundPoly(a)),this.farthestBound(a,"max","y")>c.y&&(a=this.slicePoly(a,c.y,!1)[0],this.roundPoly(a)),a},this.slicePoly=function(c,d,e){var f,g,h,j=this,k=c,j=this;e?(f={x:d,y:this.farthestBound(k,"min","y")-10},g={x:d,y:this.farthestBound(k,"max","y")+10},h=function(a,b){return j.farthestBound(a,"min","x")-j.farthestBound(b,"min","x")||j.farthestBound(a,"max","x")-j.farthestBound(b,"max","x")}):(f={x:this.farthestBound(k,"min","x")-10,y:d},g={x:this.farthestBound(k,"max","x")+10,y:d},h=function(a,b){return j.farthestBound(a,"min","y")-j.farthestBound(b,"min","y")||j.farthestBound(a,"max","y")-j.farthestBound(b,"max","y")});for(var l,m=[],n=k,o=0;o<n.length;o++){l={x:0,y:0},l=this.GetLineIntersection(f,g,n[o],n[(o+1)%n.length],l);var p=m[0],q=m[m.length-1];l&&(null==p||1e-10<this.distance(l,p))&&(null==q||1e-10<this.distance(l,q))&&(l.flag=!0,m.push(l),n.splice(o+1,0,l),o++)}if(2>m.length)return[k.slice(0)];var r=function(a,b){return j.distance(f,a)-j.distance(f,b)};m.sort(r);for(var s=[],t=0;0<m.length;){var u=m[0],v=m[1],w=n.indexOf(u),x=n.indexOf(v),y=!1;if(this.firstWithFlag(n,w)===x?y=!0:(u=m[1],v=m[0],w=n.indexOf(u),x=n.indexOf(v),this.firstWithFlag(n,w)===x&&(y=!0)),y){t--;var z=this.getPoints(n,w,x);s.push(z),n=this.getPoints(n,x,w),u.flag=v.flag=!1,m.splice(0,2),0===m.length&&s.push(n)}else t++,m.reverse();if(1<t)break}return s.sort(h),s},this.roundPoly=function(a){if(a)for(var b=a.length-1;0<=b;b--)a[b].x=f(1e3*a[b].x)/1e3,a[b].y=f(1e3*a[b].y)/1e3},this.polyArea=function(a){var b=a;if(3>b.length)return 0;for(var c=b.length-1,d=0,e=0;e<c;e++)d+=(b[e+1].x-b[e].x)*(b[e].y+b[e+1].y);return d+=(b[0].x-b[c].x)*(b[c].y+b[0].y),Math.abs(.5*-d)},this.farthestBound=function(a,b,c){if(!a)return null;return"min"==b?g(...a.map(a=>a[c])):"max"==b?i(...a.map(a=>a[c])):null},this.distance=function(c,a){var b=a.x-c.x,d=a.y-c.y;return k(b*b+d*d)},this.GetLineIntersection=function(a,b,d,e,f){var c=a.x-b.x,g=d.x-e.x,h=a.y-b.y,i=d.y-e.y,j=c*i-h*g;if(0===j)return null;var k=a.x*b.y-a.y*b.x,l=d.x*e.y-d.y*e.x,m=f;return m.x=(k*g-c*l)/j,m.y=(k*i-h*l)/j,this.InRectangle(m,a,b)&&this.InRectangle(m,d,e)?m:null},this.firstWithFlag=function(a,b){for(var c=a.length;;)if(b=(b+1)%c,a[b].flag)return b},this.getPoints=function(a,b,c){var d=a.length,e=[];c<b&&(c+=d);for(var f=b;f<=c;f++)e.push(a[f%d]);return e},this.InRectangle=function(d,a,b){var c=g(a.x,b.x),e=i(a.x,b.x),f=g(a.y,b.y),h=i(a.y,b.y);return c===e?f<=d.y&&d.y<=h:f===h?c<=d.x&&d.x<=e:c<=d.x+1e-10&&d.x-1e-10<=e&&f<=d.y+1e-10&&d.y-1e-10<=h},this.clear=function(){this.isDrawn=!1,a.clearRect(0,0,b,c)}}function ConeTemplate(a,b,c,d){Template.call(this,a,b,c,d),this.shape="cone",this.getVerts=function(){var a=this.terminus.x-this.origin.x,b=this.terminus.y-this.origin.y,c={x:this.terminus.x-b/2,y:this.terminus.y+a/2},d={x:this.terminus.x+b/2,y:this.terminus.y-a/2};return[this.origin,c,d,this.terminus]},this.draw=function(){this.isDrawn=!0;var b=this.getVerts();a.beginPath(),a.moveTo(b[0].x,b[0].y),a.lineTo(b[1].x,b[1].y),a.lineTo(b[2].x,b[2].y),a.lineTo(b[0].x,b[0].y),a.lineWidth=2,a.strokeStyle=this.lineColour,a.stroke()},this.calculateHit=function(){var a=this.getVerts(),b=[a[0],a[1],a[2]];b=this.cropPoly(b,d.origin,{x:d.origin.x+d.width,y:d.origin.y+d.height}),this.calculateHitPoly(b)}}function LineTemplate(a,b,c,d){Template.call(this,a,b,c,d),this.shape="line",this.getVerts=function(){var a=this.terminus.x-this.origin.x,b=this.terminus.y-this.origin.y,c=a/b,e=d.tile_width,f=e/2/Math.sqrt(1+c*c),g=f*c;0==a&&(f=e/2,g=0),0==b&&(g=e/2,f=0);var h={x:this.origin.x+f,y:this.origin.y-g},i={x:this.origin.x-f,y:this.origin.y+g},j={x:this.terminus.x-f,y:this.terminus.y+g},k={x:this.terminus.x+f,y:this.terminus.y-g};return[this.origin,h,i,j,k,this.terminus]},this.draw=function(){this.isDrawn=!0;var b=this.getVerts();a.beginPath(),a.moveTo(b[1].x,b[1].y),a.lineTo(b[2].x,b[2].y),a.lineTo(b[3].x,b[3].y),a.lineTo(b[4].x,b[4].y),a.lineTo(b[1].x,b[1].y),a.lineWidth=2,a.strokeStyle=this.lineColour,a.stroke()},this.calculateHit=function(){var a=this.getVerts(),b=[a[1],a[2],a[3],a[4]];b=this.cropPoly(b,d.origin,{x:d.origin.x+d.width,y:d.origin.y+d.height}),this.calculateHitPoly(b)}}function CircleTemplate(a,b,c,d){var e=Math.abs,f=Math.round,g=Math.min,h=Math.max,i=Math.PI,j=Math.sqrt;Template.call(this,a,b,c,d),this.shape="circle";this.terminusRequired=!1,this.getVerts=function(){return[this.origin,{x:this.origin.x+this.radius,y:this.origin.y}]},this.draw=function(){this.isDrawn=!0;var b=this.getVerts();a.beginPath(),a.arc(b[0].x,b[0].y,e(b[0].x-b[1].x),0,2*i),a.lineWidth=2,a.strokeStyle=this.lineColour,a.stroke()},this.calculateHit=function(){for(var a=this.getVerts(),b=d.getRowByCoord(a[0].y-this.radius)||0,c=d.getColByCoord(a[0].x-this.radius)||0,f=d.getRowByCoord(a[0].y+this.radius)||d.tile_set.length,g=d.getColByCoord(a[0].x+this.radius)||d.tile_set[0].length,h=[],i=c;i<=g;i++){var k=d.origin.x+i*d.tile_width,l=a[0].x-k;if(!(e(l)>this.radius)){var m=this.radius;0!=l&&(m=j(this.radius*this.radius-l*l)),h.push({x:k,y:a[0].y+m}),h.push({x:k,y:a[0].y-m})}}for(var n=[],o=b;o<=f;o++){var p=d.origin.y+o*d.tile_height,m=a[0].y-p;if(!(e(m)>this.radius)){var l=this.radius;0!=m&&(l=j(this.radius*this.radius-m*m)),n.push({x:a[0].x+l,y:p}),n.push({x:a[0].x-l,y:p})}}sort=function(a,b){return a.x-b.x},n.sort(sort);var q=[];if(h[0]&&h[0].x!=d.origin.x){for(;0<n.length&&n[0].x>=h[0].x-d.tile_width&&n[0].x<=h[0].x;)q.push(n.shift());this.calculateHitColumnSlice([],h.slice(0,2),q)}for(;2<=h.length&&h[0].x<d.origin.x+d.width;){for(q=[];0<n.length&&n[0].x<h[0].x;)n.shift();for(;0<n.length&&n[0].x>=h[0].x&&n[0].x<=h[0].x+d.tile_width;)q.push(n.shift());this.calculateHitColumnSlice(h.slice(0,2),h.slice(2,4),q),h=h.slice(2)}},this.calculateHitColumnSlice=function(a,b,c){var e=0<a.length?a[0].x:b[0].x-d.tile_width;e=d.getColByCoord(e);var f,j;0<a.length&&0<b.length?(f=g(a[1].y,b[1].y),j=h(a[0].y,b[0].y)):0<a.length?(f=a[1].y,j=a[0].y):(f=b[1].y,j=b[0].y);var k=h(d.getRowByCoord(f),0),l=g(null===d.getRowByCoord(j)?d.tile_set.length:d.getRowByCoord(j),d.tile_set.length-1);f>=d.origin.y+d.tile_set.length*d.tile_height&&(k=l+1),j<=d.origin.y&&(l=-1);for(var m=[],n=k;n<=l;n++){m=[];for(var o=b.length-1;0<=o;o--)(d.getRowByCoord(b[o].y)==n||b[o].y==n*d.tile_height+d.tile_height+d.origin.y)&&m.push(b[o]);for(var o=a.length-1;0<=o;o--)(d.getRowByCoord(a[o].y)==n||a[o].y==n*d.tile_height+d.tile_height+d.origin.y)&&m.push(a[o]);for(var o=c.length-1;0<=o;o--)(c[o].y==n*d.tile_height+d.origin.y||c[o].y==n*d.tile_height+d.tile_height+d.origin.y)&&m.push(c[o]);this.calculateHitTile(e,n,m)}},this.calculateHitTile=function(a,b,c){for(var f=0;f<c.length;f++)for(var g=f+1;g<c.length;g++)JSON.stringify(c[g])===JSON.stringify(c[f])&&c.splice(g,1);if(0==c.length)return void(d.tile_set[b][a].isHit=!0);if(1==c.length){var h=d.tile_set[b][a];return this.isPointInCircle(h.tile_corners[0])?this.isPointInCircle(h.tile_corners[1])?this.isPointInCircle(h.tile_corners[2])?this.isPointInCircle(h.tile_corners[3])?void(h.isHit=!0):void 0:void 0:void 0:void 0}for(var k=c.slice(),f=0;4>f;f++)this.isPointInCircle(d.tile_set[b][a].tile_corners[f])&&k.push(d.tile_set[b][a].tile_corners[f]);var l=this.getAveragePoint(k),m=this;sort=function(a,b){return m.angleBetweenPoints(l,a)-m.angleBetweenPoints(l,b)},k.sort(sort);var n=this.polyArea(k),o=0;if(n>this.minHitFactor*(d.tile_width*d.tile_height))return void(d.tile_set[b][a].isHit=!0);if(2==c.length){var p=this.getVerts()[0],q=e(this.angleBetweenPoints(p,c[1])-this.angleBetweenPoints(p,c[0]));q=i*q/180,q>i&&(q=2*i-q),o+=.5*(this.radius*this.radius)*(q-Math.sin(q))}n+o>this.minHitFactor*(d.tile_width*d.tile_height)&&(d.tile_set[b][a].isHit=!0)},this.isPointInCircle=function(a){return Math.floor(this.distance(a,this.origin))<=this.radius},this.angleBetweenPoints=function(c,a){return 180*Math.atan2(a.y-c.y,a.x-c.x)/i},this.getAveragePoint=function(a){for(var b=0,c=0,d=0;d<a.length;d++)b+=a[d].x,c+=a[d].y;return{x:b/a.length,y:c/a.length}},this.setOrigin=function(a,b){this.originLocked||(this.snapping&&(a.x=f((a.x-d.origin.x)/(d.tile_width/2))*(d.tile_width/2)+d.origin.x,a.y=f((a.y-d.origin.y)/(d.tile_width/2))*(d.tile_width/2)+d.origin.y),this.origin={x:a.x,y:a.y},this.originTile=b,null!=this.terminus_delta&&(this.terminus={x:this.origin.x-this.terminus_delta.x,y:this.origin.y-this.terminus_delta.y}))},this.setTerminus=function(a){(null==this.terminus_delta||0==this.terminus_delta.x&&0==this.terminus_delta.y)&&(this.terminus_delta={x:this.origin.x-a.x,y:this.origin.y-a.y},this.terminus=a),this.setOrigin(a)},this.setVector=function(a,b){this.radius=b,this.setOrigin(a)},this.changeMagnitude=function(a){this.radius=a}}function Tile(a,b,c,d,e,f){var g=Math.min,h=Math.max;this.is_hex=!1,this.entity,this.has_caster=!1,this.isHit=!1,this.tile_corners=[{x:a,y:b},{x:a+d,y:b},{x:a+d,y:b+c},{x:a,y:b+c}],this.currentFill=null,this.gridColor="#2C363F",this.drawTile=function(){e.beginPath(),e.moveTo(.5+this.tile_corners[0].x,.5+this.tile_corners[0].y),e.lineTo(.5+this.tile_corners[1].x,.5+this.tile_corners[1].y),e.lineTo(.5+this.tile_corners[2].x,.5+this.tile_corners[2].y),e.lineTo(.5+this.tile_corners[3].x,.5+this.tile_corners[3].y),e.lineTo(.5+this.tile_corners[0].x,.5+this.tile_corners[0].y),e.strokeStyle=this.gridColor,e.stroke()},this.fillTile=function(e="red"){this.currentFill=e,f.beginPath(),f.rect(a+1,b+1,d-1,c-1),f.fillStyle=e,f.fill()},this.clearTile=function(){this.currentFill=null,f.clearRect(a+1,b+1,d-1,c-1)},this.calculateHitCone=function(a){var b=a.getConeVerts(),c={x:h(b[0].x,b[1].x,b[2].x),y:h(b[0].y,b[1].y,b[2].y)},d={x:g(b[0].x,b[1].x,b[2].x),y:g(b[0].y,b[1].y,b[2].y)};return this.tile_corners[2].x<d.x||this.tile_corners[2].y<d.y?(this.isHit=!1,void this.clearTile()):this.tile_corners[0].x>c.x||this.tile_corners[0].y>c.y?(this.isHit=!1,void this.clearTile()):(cornersHit=1*this.isPointInTriangle(this.tile_corners[0],b)+1*this.isPointInTriangle(this.tile_corners[1],b)+1*this.isPointInTriangle(this.tile_corners[2],b)+1*this.isPointInTriangle(this.tile_corners[3],b),3<=cornersHit)?(this.fillTile("#FF3300"),void(this.isHit=!0)):2==cornersHit?(this.fillTile("#FF7700"),void(this.isHit=!1)):1==cornersHit?(this.fillTile("#FFCC00"),void(this.isHit=!1)):void(this.isHit=!1,this.clearTile())},this.isPointInTriangle=function(a,b){var c=.5*(-b[1].y*b[2].x+b[0].y*(-b[1].x+b[2].x)+b[0].x*(b[1].y-b[2].y)+b[1].x*b[2].y),d=Math.sign(c),e=(b[0].y*b[2].x-b[0].x*b[2].y+(b[2].y-b[0].y)*a.x+(b[0].x-b[2].x)*a.y)*d,f=(b[0].x*b[1].y-b[0].y*b[1].x+(b[0].y-b[1].y)*a.x+(b[1].x-b[0].x)*a.y)*d;return 0<e&&0<f&&e+f<2*c*d}}function Unit(a,b,c){var d=Math.PI;this.radius=12,this.hitColour="#3B6182",this.regColour="#3B6182",this.shape=b,this.draw=function(){var b={x:(a.tile_corners[1].x+a.tile_corners[0].x)/2,y:(a.tile_corners[3].y+a.tile_corners[0].y)/2};2<this.shape&&7>this.shape?this.drawPoly(b,this.shape):this.drawCircle(b),a.isHit&&this.crossOut()},this.drawCircle=function(b){c.beginPath(),c.arc(b.x,b.y,this.radius,0,2*d),c.fillStyle=a.isHit?this.hitColour:this.regColour,c.fill()},this.drawPoly=function(b,e){verts=[],verts.push({x:b.x,y:b.y-this.radius});for(var f=2*d/e,g=1;g<e;g++)verts.push({x:b.x+this.radius*Math.cos(f*g+d/2),y:b.y-this.radius*Math.sin(f*g+d/2)});c.beginPath();for(var g=0;g<verts.length;g++)c.lineTo(verts[g].x,verts[g].y);c.fillStyle=a.isHit?this.hitColour:this.regColour,c.fill()},this.crossOut=function(){c.beginPath(),c.moveTo(a.tile_corners[0].x+1,a.tile_corners[0].y+1),c.lineTo(a.tile_corners[2].x-1,a.tile_corners[2].y-1),c.moveTo(a.tile_corners[1].x-1,a.tile_corners[1].y+1),c.lineTo(a.tile_corners[3].x+1,a.tile_corners[3].y-1),c.strokeStyle=a.currentFill,c.lineWidth=2,c.stroke()},this.setTile=function(b){a=b},this.setShape=function(a){this.shape=a},this.clear=function(){c.clearRect(a.tile_corners[0].x,a.tile_corners[0].y,a.tile_corners[1].x-a.tile_corners[0].x,a.tile_corners[3].y-a.tile_corners[0].y)}}